// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model (references external user service)
model User {
  id                String   @id @default(cuid())
  externalUserId    String   @unique // Reference to user service
  username          String   @unique
  email             String   @unique
  displayName       String?
  avatar            String?
  bio               String?
  reputation        Int      @default(0)
  isModerator       Boolean  @default(false)
  isBanned          Boolean  @default(false)
  banReason         String?
  banExpiresAt      DateTime?
  lastActiveAt      DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  posts             Post[]
  comments          Comment[]
  postVotes         PostVote[]
  commentVotes      CommentVote[]
  studyGroups       StudyGroupMember[]
  ownedStudyGroups  StudyGroup[] @relation("StudyGroupOwner")
  friendRequests    FriendRequest[] @relation("FriendRequestSender")
  friendRequestsReceived FriendRequest[] @relation("FriendRequestReceiver")
  friendships       Friendship[] @relation("FriendshipUser")
  friendshipsReceived Friendship[] @relation("FriendshipFriend")
  followers         Follow[] @relation("FollowFollowing")
  following         Follow[] @relation("FollowFollower")
  reports           Report[] @relation("ReportReporter")
  reportedContent   Report[] @relation("ReportReported")
  activities        Activity[]
  achievements      UserAchievement[]
  leaderboardEntries LeaderboardEntry[]
  mentorshipRequests MentorshipRequest[] @relation("MentorshipRequestMentor")
  mentorshipRequestsReceived MentorshipRequest[] @relation("MentorshipRequestMentee")

  @@map("users")
}

// Forum Categories
model ForumCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  slug        String   @unique
  icon        String?
  color       String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  posts       Post[]

  @@map("forum_categories")
}

// Forum Posts/Threads
model Post {
  id          String   @id @default(cuid())
  title       String
  content     String
  slug        String   @unique
  categoryId  String
  authorId    String
  isPinned    Boolean  @default(false)
  isLocked    Boolean  @default(false)
  isDeleted   Boolean  @default(false)
  viewCount   Int      @default(0)
  upvotes     Int      @default(0)
  downvotes   Int      @default(0)
  commentCount Int     @default(0)
  lastActivityAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  category    ForumCategory @relation(fields: [categoryId], references: [id])
  author      User          @relation(fields: [authorId], references: [id])
  comments    Comment[]
  votes       PostVote[]
  reports     Report[]

  @@map("posts")
}

// Post Comments
model Comment {
  id        String   @id @default(cuid())
  content   String
  postId    String
  authorId  String
  parentId  String?  // For nested replies
  isDeleted Boolean  @default(false)
  upvotes   Int      @default(0)
  downvotes Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  post      Post      @relation(fields: [postId], references: [id])
  author    User      @relation(fields: [authorId], references: [id])
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  votes     CommentVote[]
  reports   Report[]

  @@map("comments")
}

// Post Votes
model PostVote {
  id     String @id @default(cuid())
  postId String
  userId String
  type   VoteType
  createdAt DateTime @default(now())

  // Relations
  post   Post @relation(fields: [postId], references: [id])
  user   User @relation(fields: [userId], references: [id])

  @@unique([postId, userId])
  @@map("post_votes")
}

// Comment Votes
model CommentVote {
  id        String @id @default(cuid())
  commentId String
  userId    String
  type      VoteType
  createdAt DateTime @default(now())

  // Relations
  comment Comment @relation(fields: [commentId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([commentId, userId])
  @@map("comment_votes")
}

// Study Groups
model StudyGroup {
  id          String   @id @default(cuid())
  name        String
  description String?
  slug        String   @unique
  ownerId     String
  isPublic    Boolean  @default(true)
  maxMembers  Int      @default(50)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  owner       User             @relation("StudyGroupOwner", fields: [ownerId], references: [id])
  members     StudyGroupMember[]
  challenges  StudyGroupChallenge[]
  activities  Activity[]

  @@map("study_groups")
}

// Study Group Members
model StudyGroupMember {
  id           String   @id @default(cuid())
  groupId      String
  userId       String
  role         GroupRole @default(MEMBER)
  joinedAt     DateTime @default(now())
  isActive     Boolean  @default(true)

  // Relations
  group        StudyGroup @relation(fields: [groupId], references: [id])
  user         User       @relation(fields: [userId], references: [id])

  @@unique([groupId, userId])
  @@map("study_group_members")
}

// Study Group Challenges
model StudyGroupChallenge {
  id          String   @id @default(cuid())
  groupId     String
  title       String
  description String
  type        ChallengeType
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  group       StudyGroup @relation(fields: [groupId], references: [id])

  @@map("study_group_challenges")
}

// Friend Requests
model FriendRequest {
  id        String   @id @default(cuid())
  senderId  String
  receiverId String
  status    FriendRequestStatus @default(PENDING)
  message   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sender    User @relation("FriendRequestSender", fields: [senderId], references: [id])
  receiver  User @relation("FriendRequestReceiver", fields: [receiverId], references: [id])

  @@unique([senderId, receiverId])
  @@map("friend_requests")
}

// Friendships
model Friendship {
  id       String   @id @default(cuid())
  userId   String
  friendId String
  createdAt DateTime @default(now())

  // Relations
  user     User @relation("FriendshipUser", fields: [userId], references: [id])
  friend   User @relation("FriendshipFriend", fields: [friendId], references: [id])

  @@unique([userId, friendId])
  @@map("friendships")
}

// Follow System
model Follow {
  id         String   @id @default(cuid())
  followerId String
  followingId String
  createdAt  DateTime @default(now())

  // Relations
  follower   User @relation("FollowFollower", fields: [followerId], references: [id])
  following  User @relation("FollowFollowing", fields: [followingId], references: [id])

  @@unique([followerId, followingId])
  @@map("follows")
}

// Content Reports
model Report {
  id          String   @id @default(cuid())
  reporterId  String
  reportedId  String?  // User being reported
  postId      String?  // Post being reported
  commentId   String?  // Comment being reported
  reason      ReportReason
  description String?
  status      ReportStatus @default(PENDING)
  moderatorId String?
  moderatorNotes String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  reporter   User     @relation("ReportReporter", fields: [reporterId], references: [id])
  reported   User?    @relation("ReportReported", fields: [reportedId], references: [id])
  post       Post?    @relation(fields: [postId], references: [id])
  comment    Comment? @relation(fields: [commentId], references: [id])

  @@map("reports")
}

// User Activities
model Activity {
  id        String   @id @default(cuid())
  userId    String
  type      ActivityType
  title     String
  description String?
  metadata  Json?
  groupId   String?
  createdAt DateTime @default(now())

  // Relations
  user      User        @relation(fields: [userId], references: [id])
  group     StudyGroup? @relation(fields: [groupId], references: [id])

  @@map("activities")
}

// User Achievements
model UserAchievement {
  id           String   @id @default(cuid())
  userId       String
  achievementType AchievementType
  title        String
  description  String
  icon         String?
  points       Int      @default(0)
  unlockedAt   DateTime @default(now())

  // Relations
  user         User @relation(fields: [userId], references: [id])

  @@unique([userId, achievementType])
  @@map("user_achievements")
}

// Leaderboard Entries
model LeaderboardEntry {
  id        String   @id @default(cuid())
  userId    String
  type      LeaderboardType
  score     Int
  rank      Int?
  period    String?  // daily, weekly, monthly, all-time
  category  String?  // for category-specific leaderboards
  updatedAt DateTime @updatedAt

  // Relations
  user      User @relation(fields: [userId], references: [id])

  @@unique([userId, type, period, category])
  @@map("leaderboard_entries")
}

// Mentorship Requests
model MentorshipRequest {
  id          String   @id @default(cuid())
  mentorId    String
  menteeId    String
  message     String?
  status      MentorshipStatus @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  mentor      User @relation("MentorshipRequestMentor", fields: [mentorId], references: [id])
  mentee      User @relation("MentorshipRequestMentee", fields: [menteeId], references: [id])

  @@unique([mentorId, menteeId])
  @@map("mentorship_requests")
}

// Enums
enum VoteType {
  UPVOTE
  DOWNVOTE
}

enum GroupRole {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
}

enum ChallengeType {
  DAILY_STREAK
  WEEKLY_GOAL
  MONTHLY_CHALLENGE
  CUSTOM
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELLED
}

enum ReportReason {
  SPAM
  HARASSMENT
  INAPPROPRIATE_CONTENT
  HATE_SPEECH
  COPYRIGHT_VIOLATION
  OTHER
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

enum ActivityType {
  POST_CREATED
  COMMENT_ADDED
  ACHIEVEMENT_UNLOCKED
  FRIEND_ADDED
  GROUP_JOINED
  CHALLENGE_COMPLETED
  MILESTONE_REACHED
}

enum AchievementType {
  FIRST_POST
  HELPFUL_MEMBER
  ACTIVE_PARTICIPANT
  STUDY_GROUP_LEADER
  MENTOR
  STREAK_MASTER
  KNOWLEDGE_SHARER
  COMMUNITY_BUILDER
}

enum LeaderboardType {
  REPUTATION
  POSTS_COUNT
  COMMENTS_COUNT
  STUDY_STREAK
  CHARACTERS_LEARNED
  GROUPS_JOINED
  ACHIEVEMENTS_COUNT
}

enum MentorshipStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELLED
  COMPLETED
}
