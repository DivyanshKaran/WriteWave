# Custom Nginx configuration for Kong
# This file extends the default Kong configuration

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=ip_limit:10m rate=1000r/m;
limit_req_zone $http_authorization zone=user_limit:10m rate=100r/m;

# Upstream service health checks
upstream user_service {
    server user-service:80 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream content_service {
    server content-service:80 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream progress_service {
    server progress-service:80 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream community_service {
    server community-service:80 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream notification_service {
    server notification-service:80 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream analytics_service {
    server analytics-service:80 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream health_check_service {
    server health-check-service:80 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# Circuit breaker configuration
map $upstream_status $circuit_breaker {
    default 0;
    ~^[5] 1;
}

# Logging format
log_format json_combined escape=json
  '{'
    '"time_local":"$time_local",'
    '"remote_addr":"$remote_addr",'
    '"request":"$request",'
    '"status": "$status",'
    '"body_bytes_sent":"$body_bytes_sent",'
    '"request_time":"$request_time",'
    '"http_referrer":"$http_referer",'
    '"http_user_agent":"$http_user_agent",'
    '"upstream_response_time":"$upstream_response_time",'
    '"upstream_status":"$upstream_status",'
    '"kong_request_id":"$kong_request_id",'
    '"service_name":"$kong_service_name",'
    '"route_name":"$kong_route_name"'
  '}';

# Security headers
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header X-Kong-Request-ID $kong_request_id always;

# CORS headers
add_header Access-Control-Allow-Origin "*" always;
add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH" always;
add_header Access-Control-Allow-Headers "Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, Authorization, X-Requested-With" always;
add_header Access-Control-Expose-Headers "X-Auth-Token, X-User-ID, X-User-Role, X-Service, X-Version" always;
add_header Access-Control-Allow-Credentials "true" always;

# Handle preflight requests
if ($request_method = 'OPTIONS') {
    add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH";
    add_header Access-Control-Allow-Headers "Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, Authorization, X-Requested-With";
    add_header Access-Control-Max-Age 3600;
    add_header Content-Length 0;
    add_header Content-Type text/plain;
    return 204;
}

# Rate limiting
limit_req zone=ip_limit burst=20 nodelay;
limit_req zone=user_limit burst=10 nodelay;

# Request size limits
client_max_body_size 10M;
client_body_buffer_size 128k;

# Timeouts
client_body_timeout 60s;
client_header_timeout 60s;
keepalive_timeout 65s;
send_timeout 60s;

# Gzip compression
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_proxied any;
gzip_comp_level 6;
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/json
    application/javascript
    application/xml+rss
    application/atom+xml
    image/svg+xml;

# Cache configuration
proxy_cache_path /tmp/kong_cache levels=1:2 keys_zone=kong_cache:10m max_size=1g inactive=60m use_temp_path=off;

# Health check endpoint
location /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
}

# Metrics endpoint
location /metrics {
    access_log off;
    return 200 "metrics\n";
    add_header Content-Type text/plain;
}

# Service discovery endpoint
location /services {
    access_log off;
    return 200 '{"services":["user-service","content-service","progress-service","community-service","notification-service","analytics-service"]}';
    add_header Content-Type application/json;
}

# Load balancing configuration
upstream backend {
    least_conn;
    server user-service:80 weight=1 max_fails=3 fail_timeout=30s;
    server content-service:80 weight=1 max_fails=3 fail_timeout=30s;
    server progress-service:80 weight=1 max_fails=3 fail_timeout=30s;
    server community-service:80 weight=1 max_fails=3 fail_timeout=30s;
    server notification-service:80 weight=1 max_fails=3 fail_timeout=30s;
    server analytics-service:80 weight=1 max_fails=3 fail_timeout=30s;
}

# Error handling
error_page 400 401 403 404 405 408 409 410 411 412 413 414 415 416 417 418 421 422 423 424 425 426 428 429 431 451 500 501 502 503 504 505 506 507 508 510 511 /error;

location = /error {
    internal;
    return 200 '{"error": "Service temporarily unavailable", "message": "Please try again later", "timestamp": "$time_iso8601", "request_id": "$kong_request_id"}';
    add_header Content-Type application/json;
}