_format_version: "3.0"

# Service definitions for 6 microservices
services:
  # User Service
  - name: user-service
    url: http://user-service:80
    routes:
      - name: user-service-v1
        paths:
          - /api/v1/users
          - /api/v1/auth
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
        plugins:
          - name: jwt
            config:
              key_claim_name: iss
              secret_is_base64: false
              run_on_preflight: true
          - name: rate-limiting
            config:
              minute: 100
              hour: 1000
              policy: redis
              redis_host: redis
              redis_port: 6379
              fault_tolerant: true
          - name: cors
            config:
              origins:
                - http://localhost:3000
                - http://localhost:8080
                - https://writewave.app
                - https://staging.writewave.app
              methods:
                - GET
                - POST
                - PUT
                - DELETE
                - PATCH
                - OPTIONS
              headers:
                - Accept
                - Accept-Version
                - Content-Length
                - Content-MD5
                - Content-Type
                - Date
                - Authorization
                - X-Requested-With
              exposed_headers:
                - X-Auth-Token
                - X-User-ID
                - X-User-Role
              credentials: true
              max_age: 3600
          - name: request-logging
            config:
              log_requests: true
              log_responses: true
              log_to_redis: true
              log_to_file: true
              add_response_time_header: true
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Service: user-service"
                  - "X-Version: v1"
          - name: circuit-breaker
            config:
              threshold: 5
              timeout: 60
              unhealthy: 3
              healthy: 2
              redis_host: redis
              redis_port: 6379

  # Content Service
  - name: content-service
    url: http://content-service:80
    routes:
      - name: content-service-v1
        paths:
          - /api/v1/content
          - /api/v1/characters
          - /api/v1/kanji
          - /api/v1/hiragana
          - /api/v1/katakana
          - /api/v1/vocabulary
          - /api/v1/lessons
          - /api/v1/media
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        plugins:
          - name: jwt
            config:
              key_claim_name: iss
              secret_is_base64: false
              run_on_preflight: true
          - name: rate-limiting
            config:
              minute: 100
              hour: 1000
              policy: redis
              redis_host: redis
              redis_port: 6379
              fault_tolerant: true
          - name: cors
            config:
              origins:
                - http://localhost:3000
                - http://localhost:8080
                - https://writewave.app
                - https://staging.writewave.app
              methods:
                - GET
                - POST
                - PUT
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Accept-Version
                - Content-Length
                - Content-MD5
                - Content-Type
                - Date
                - Authorization
                - X-Requested-With
              exposed_headers:
                - X-Auth-Token
                - X-User-ID
                - X-User-Role
              credentials: true
              max_age: 3600
          - name: request-logging
            config:
              log_requests: true
              log_responses: true
              log_to_redis: true
              log_to_file: true
              add_response_time_header: true
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Service: content-service"
                  - "X-Version: v1"
          - name: circuit-breaker
            config:
              threshold: 5
              timeout: 60
              unhealthy: 3
              healthy: 2
              redis_host: redis
              redis_port: 6379

  # Articles Service
  - name: articles-service
    url: http://articles-service:80
    routes:
      - name: articles-service-v1
        paths:
          - /api/articles
          - /api/v1/articles
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
        plugins:
          - name: jwt
            config:
              key_claim_name: iss
              secret_is_base64: false
              run_on_preflight: true
          - name: rate-limiting
            config:
              minute: 100
              hour: 1000
              policy: redis
              redis_host: redis
              redis_port: 6379
              fault_tolerant: true
          - name: cors
            config:
              origins:
                - http://localhost:3000
                - http://localhost:8080
                - https://writewave.app
                - https://staging.writewave.app
              methods:
                - GET
                - POST
                - PUT
                - DELETE
                - PATCH
                - OPTIONS
              headers:
                - Accept
                - Accept-Version
                - Content-Length
                - Content-MD5
                - Content-Type
                - Date
                - Authorization
                - X-Requested-With
              exposed_headers:
                - X-Auth-Token
                - X-User-ID
                - X-User-Role
              credentials: true
              max_age: 3600
          - name: request-logging
            config:
              log_requests: true
              log_responses: true
              log_to_redis: true
              log_to_file: true
              add_response_time_header: true
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Service: articles-service"
                  - "X-Version: v1"
                  - "X-Port: 8007"
          - name: circuit-breaker
            config:
              threshold: 5
              timeout: 60
              unhealthy: 3
              healthy: 2
              redis_host: redis
              redis_port: 6379

  # Progress Service
  - name: progress-service
    url: http://progress-service:80
    routes:
      - name: progress-service-v1
        paths:
          - /api/v1/progress
          - /api/v1/achievements
          - /api/v1/stats
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        plugins:
          - name: jwt
            config:
              key_claim_name: iss
              secret_is_base64: false
              run_on_preflight: true
          - name: rate-limiting
            config:
              minute: 100
              hour: 1000
              policy: redis
              redis_host: redis
              redis_port: 6379
              fault_tolerant: true
          - name: cors
            config:
              origins:
                - http://localhost:3000
                - http://localhost:8080
                - https://writewave.app
                - https://staging.writewave.app
              methods:
                - GET
                - POST
                - PUT
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Accept-Version
                - Content-Length
                - Content-MD5
                - Content-Type
                - Date
                - Authorization
                - X-Requested-With
              exposed_headers:
                - X-Auth-Token
                - X-User-ID
                - X-User-Role
              credentials: true
              max_age: 3600
          - name: request-logging
            config:
              log_requests: true
              log_responses: true
              log_to_redis: true
              log_to_file: true
              add_response_time_header: true
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Service: progress-service"
                  - "X-Version: v1"
          - name: circuit-breaker
            config:
              threshold: 5
              timeout: 60
              unhealthy: 3
              healthy: 2
              redis_host: redis
              redis_port: 6379

  # Community Service
  - name: community-service
    url: http://community-service:80
    routes:
      - name: community-service-v1
        paths:
          - /api/v1/community
          - /api/v1/discussions
          - /api/v1/groups
          - /api/v1/leaderboard
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        plugins:
          - name: jwt
            config:
              key_claim_name: iss
              secret_is_base64: false
              run_on_preflight: true
          - name: rate-limiting
            config:
              minute: 100
              hour: 1000
              policy: redis
              redis_host: redis
              redis_port: 6379
              fault_tolerant: true
          - name: cors
            config:
              origins:
                - http://localhost:3000
                - http://localhost:8080
                - https://writewave.app
                - https://staging.writewave.app
              methods:
                - GET
                - POST
                - PUT
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Accept-Version
                - Content-Length
                - Content-MD5
                - Content-Type
                - Date
                - Authorization
                - X-Requested-With
              exposed_headers:
                - X-Auth-Token
                - X-User-ID
                - X-User-Role
              credentials: true
              max_age: 3600
          - name: request-logging
            config:
              log_requests: true
              log_responses: true
              log_to_redis: true
              log_to_file: true
              add_response_time_header: true
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Service: community-service"
                  - "X-Version: v1"
          - name: circuit-breaker
            config:
              threshold: 5
              timeout: 60
              unhealthy: 3
              healthy: 2
              redis_host: redis
              redis_port: 6379

  # Notification Service
  - name: notification-service
    url: http://notification-service:80
    routes:
      - name: notification-service-v1
        paths:
          - /api/v1/notifications
          - /api/notifications
          - /api/v1/websocket
          - /api/v1/preferences
          - /api/preferences
          - /api/v1/subscriptions
          - /api/subscriptions
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        plugins:
          - name: jwt
            config:
              key_claim_name: iss
              secret_is_base64: false
              run_on_preflight: true
          - name: rate-limiting
            config:
              minute: 100
              hour: 1000
              policy: redis
              redis_host: redis
              redis_port: 6379
              fault_tolerant: true
          - name: cors
            config:
              origins:
                - http://localhost:3000
                - http://localhost:8080
                - https://writewave.app
                - https://staging.writewave.app
              methods:
                - GET
                - POST
                - PUT
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Accept-Version
                - Content-Length
                - Content-MD5
                - Content-Type
                - Date
                - Authorization
                - X-Requested-With
              exposed_headers:
                - X-Auth-Token
                - X-User-ID
                - X-User-Role
              credentials: true
              max_age: 3600
          - name: request-logging
            config:
              log_requests: true
              log_responses: true
              log_to_redis: true
              log_to_file: true
              add_response_time_header: true
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Service: notification-service"
                  - "X-Version: v1"
          - name: circuit-breaker
            config:
              threshold: 5
              timeout: 60
              unhealthy: 3
              healthy: 2
              redis_host: redis
              redis_port: 6379

  # Analytics Service
  - name: analytics-service
    url: http://analytics-service:80
    routes:
      - name: analytics-service-v1
        paths:
          - /api/v1/analytics
          - /api/v1/metrics
          - /api/v1/reports
          - /api/v1/events
          - /api/events
          - /api/v1/dashboards
          - /api/dashboards
          - /api/v1/ab-tests
          - /api/ab-tests
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        plugins:
          - name: jwt
            config:
              key_claim_name: iss
              secret_is_base64: false
              run_on_preflight: true
          - name: rate-limiting
            config:
              minute: 100
              hour: 1000
              policy: redis
              redis_host: redis
              redis_port: 6379
              fault_tolerant: true
          - name: cors
            config:
              origins:
                - http://localhost:3000
                - http://localhost:8080
                - https://writewave.app
                - https://staging.writewave.app
              methods:
                - GET
                - POST
                - PUT
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Accept-Version
                - Content-Length
                - Content-MD5
                - Content-Type
                - Date
                - Authorization
                - X-Requested-With
              exposed_headers:
                - X-Auth-Token
                - X-User-ID
                - X-User-Role
              credentials: true
              max_age: 3600
          - name: request-logging
            config:
              log_requests: true
              log_responses: true
              log_to_redis: true
              log_to_file: true
              add_response_time_header: true
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Service: analytics-service"
                  - "X-Version: v1"
          - name: circuit-breaker
            config:
              threshold: 5
              timeout: 60
              unhealthy: 3
              healthy: 2
              redis_host: redis
              redis_port: 6379

# Health check endpoints for each service
  - name: health-check-service
    url: http://health-check-service:80
    routes:
      - name: health-check-route
        paths:
          - /health
          - /health/users
          - /health/content
          - /health/articles
          - /health/progress
          - /health/community
          - /health/notifications
          - /health/analytics
        methods:
          - GET
        plugins:
          - name: cors
            config:
              origins:
                - http://localhost:3000
                - http://localhost:8080
                - https://writewave.app
                - https://staging.writewave.app
              methods:
                - GET
                - OPTIONS
              headers:
                - Accept
                - Content-Type
              credentials: true
              max_age: 3600
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Service: health-check"
                  - "X-Version: v1"

# Global plugins
plugins:
  # Correlation ID plugin - generate and propagate request IDs
  - name: correlation-id
    config:
      header_name: X-Request-ID
      echo_downstream: true
      generator: uuid # Options: uuid, uuid-counter, track
  - name: request-logging
    config:
      log_level: info
      log_format: json
      log_to_redis: true
      log_to_file: true
      include_correlation_id: true
  - name: ip-restriction
    config:
      whitelist:
        - 127.0.0.1
        - 192.168.0.0/16
        - 10.0.0.0/8
        - 172.16.0.0/12
  - name: error-handler
    config:
      error_response_format: json
      include_request_details: true
      log_errors: true
      include_correlation_id: true