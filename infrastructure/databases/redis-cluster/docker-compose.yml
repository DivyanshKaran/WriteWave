version: '3.8'

services:
  # Redis Cluster Nodes
  redis-node-1:
    image: redis:7-alpine
    container_name: redis-node-1
    command: >
      redis-server
      --port 7001
      --cluster-enabled yes
      --cluster-config-file nodes-7001.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfilename "appendonly-7001.aof"
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 60
      --timeout 300
    ports:
      - "7001:7001"
      - "17001:17001"
    volumes:
      - redis_node_1_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - redis-cluster-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "7001", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis-node-2:
    image: redis:7-alpine
    container_name: redis-node-2
    command: >
      redis-server
      --port 7002
      --cluster-enabled yes
      --cluster-config-file nodes-7002.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfilename "appendonly-7002.aof"
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 60
      --timeout 300
    ports:
      - "7002:7002"
      - "17002:17002"
    volumes:
      - redis_node_2_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - redis-cluster-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "7002", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis-node-3:
    image: redis:7-alpine
    container_name: redis-node-3
    command: >
      redis-server
      --port 7003
      --cluster-enabled yes
      --cluster-config-file nodes-7003.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfilename "appendonly-7003.aof"
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 60
      --timeout 300
    ports:
      - "7003:7003"
      - "17003:17003"
    volumes:
      - redis_node_3_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - redis-cluster-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "7003", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis-node-4:
    image: redis:7-alpine
    container_name: redis-node-4
    command: >
      redis-server
      --port 7004
      --cluster-enabled yes
      --cluster-config-file nodes-7004.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfilename "appendonly-7004.aof"
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 60
      --timeout 300
    ports:
      - "7004:7004"
      - "17004:17004"
    volumes:
      - redis_node_4_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - redis-cluster-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "7004", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis-node-5:
    image: redis:7-alpine
    container_name: redis-node-5
    command: >
      redis-server
      --port 7005
      --cluster-enabled yes
      --cluster-config-file nodes-7005.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfilename "appendonly-7005.aof"
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 60
      --timeout 300
    ports:
      - "7005:7005"
      - "17005:17005"
    volumes:
      - redis_node_5_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - redis-cluster-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "7005", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis-node-6:
    image: redis:7-alpine
    container_name: redis-node-6
    command: >
      redis-server
      --port 7006
      --cluster-enabled yes
      --cluster-config-file nodes-7006.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfilename "appendonly-7006.aof"
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 60
      --timeout 300
    ports:
      - "7006:7006"
      - "17006:17006"
    volumes:
      - redis_node_6_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - redis-cluster-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "7006", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cluster Initialization
  redis-cluster-init:
    image: redis:7-alpine
    container_name: redis-cluster-init
    depends_on:
      - redis-node-1
      - redis-node-2
      - redis-node-3
      - redis-node-4
      - redis-node-5
      - redis-node-6
    networks:
      - redis-cluster-network
    command: >
      sh -c "
        echo 'Waiting for Redis nodes to be ready...'
        sleep 10
        echo 'Creating Redis cluster...'
        redis-cli --cluster create
        redis-node-1:7001
        redis-node-2:7002
        redis-node-3:7003
        redis-node-4:7004
        redis-node-5:7005
        redis-node-6:7006
        --cluster-replicas 1
        --cluster-yes
        echo 'Redis cluster created successfully!'
      "
    restart: "no"

  # Redis Cluster Proxy (Redis Cluster Proxy)
  redis-cluster-proxy:
    image: redis/redis-cluster-proxy:latest
    container_name: redis-cluster-proxy
    environment:
      REDIS_CLUSTER_NODES: "redis-node-1:7001,redis-node-2:7002,redis-node-3:7003,redis-node-4:7004,redis-node-5:7005,redis-node-6:7006"
      PROXY_PORT: 6379
      PROXY_TIMEOUT: 1000
      PROXY_MAX_CONNECTIONS: 1000
    ports:
      - "6379:6379"
    depends_on:
      - redis-cluster-init
    networks:
      - redis-cluster-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Sentinel for High Availability
  redis-sentinel-1:
    image: redis:7-alpine
    container_name: redis-sentinel-1
    command: >
      redis-sentinel
      /usr/local/etc/redis/sentinel.conf
      --port 26379
      --sentinel announce-ip redis-sentinel-1
      --sentinel announce-port 26379
    ports:
      - "26379:26379"
    volumes:
      - ./sentinel.conf:/usr/local/etc/redis/sentinel.conf
    networks:
      - redis-cluster-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "26379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis-sentinel-2:
    image: redis:7-alpine
    container_name: redis-sentinel-2
    command: >
      redis-sentinel
      /usr/local/etc/redis/sentinel.conf
      --port 26380
      --sentinel announce-ip redis-sentinel-2
      --sentinel announce-port 26380
    ports:
      - "26380:26380"
    volumes:
      - ./sentinel.conf:/usr/local/etc/redis/sentinel.conf
    networks:
      - redis-cluster-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "26380", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis-sentinel-3:
    image: redis:7-alpine
    container_name: redis-sentinel-3
    command: >
      redis-sentinel
      /usr/local/etc/redis/sentinel.conf
      --port 26381
      --sentinel announce-ip redis-sentinel-3
      --sentinel announce-port 26381
    ports:
      - "26381:26381"
    volumes:
      - ./sentinel.conf:/usr/local/etc/redis/sentinel.conf
    networks:
      - redis-cluster-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "26381", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cluster Management Tool
  redis-cluster-manager:
    image: redis:7-alpine
    container_name: redis-cluster-manager
    depends_on:
      - redis-cluster-init
    networks:
      - redis-cluster-network
    command: >
      sh -c "
        echo 'Redis Cluster Manager started'
        while true; do
          echo 'Cluster status:'
          redis-cli -c -h redis-cluster-proxy -p 6379 cluster nodes
          echo 'Cluster info:'
          redis-cli -c -h redis-cluster-proxy -p 6379 cluster info
          sleep 60
        done
      "
    restart: unless-stopped

  # Redis Monitoring
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: redis-exporter
    environment:
      REDIS_ADDR: "redis://redis-cluster-proxy:6379"
      REDIS_EXPORTER_INCLUDE_SYSTEM_METRICS: "true"
      REDIS_EXPORTER_LOG_FORMAT: "txt"
    ports:
      - "9121:9121"
    depends_on:
      - redis-cluster-proxy
    networks:
      - redis-cluster-network
    restart: unless-stopped

volumes:
  redis_node_1_data:
  redis_node_2_data:
  redis_node_3_data:
  redis_node_4_data:
  redis_node_5_data:
  redis_node_6_data:

networks:
  redis-cluster-network:
    driver: bridge
