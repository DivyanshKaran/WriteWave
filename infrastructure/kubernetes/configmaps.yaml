apiVersion: v1
kind: ConfigMap
metadata:
  name: writewave-config
  namespace: writewave
  labels:
    app.kubernetes.io/name: writewave-config
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/component: configuration
    app.kubernetes.io/part-of: writewave-platform
data:
  # Application Configuration
  NODE_ENV: "production"
  LOG_LEVEL: "info"
  CORS_ORIGIN: "https://writewave.com,https://app.writewave.com"
  
  # Database Configuration
  POSTGRES_HOST: "postgres-user-primary"
  POSTGRES_PORT: "5432"
  POSTGRES_DATABASE: "writewave_users"
  POSTGRES_USERNAME: "postgres"
  
  # Redis Configuration
  REDIS_HOST: "redis-cluster-proxy"
  REDIS_PORT: "6379"
  
  # Message Queue Configuration
  RABBITMQ_HOST: "rabbitmq"
  RABBITMQ_PORT: "5672"
  RABBITMQ_USERNAME: "writewave"
  
  KAFKA_BROKERS: "kafka-1:9092,kafka-2:9093,kafka-3:9094"
  
  # ClickHouse Configuration
  CLICKHOUSE_HOST: "clickhouse"
  CLICKHOUSE_PORT: "8123"
  CLICKHOUSE_DATABASE: "analytics"
  
  # Service URLs
  USER_SERVICE_URL: "http://user-service:8001"
  CONTENT_SERVICE_URL: "http://content-service:8002"
  PROGRESS_SERVICE_URL: "http://progress-service:8003"
  COMMUNITY_SERVICE_URL: "http://community-service:8004"
  NOTIFICATION_SERVICE_URL: "http://notification-service:8005"
  ANALYTICS_SERVICE_URL: "http://analytics-service:8006"
  
  # Performance Configuration
  DB_POOL_MIN: "5"
  DB_POOL_MAX: "20"
  DB_POOL_IDLE_TIMEOUT: "30000"
  CACHE_TTL: "3600"
  CACHE_MAX_SIZE: "1000"
  
  # Rate Limiting
  RATE_LIMIT_WINDOW_MS: "900000"
  RATE_LIMIT_MAX_REQUESTS: "1000"
  RATE_LIMIT_EVENTS_PER_MINUTE: "10000"
  RATE_LIMIT_API_CALLS_PER_MINUTE: "1000"
  
  # Health Check Configuration
  HEALTH_CHECK_INTERVAL: "30s"
  HEALTH_CHECK_TIMEOUT: "5s"
  HEALTH_CHECK_RETRIES: "3"
  
  # Metrics Configuration
  METRICS_ENABLED: "true"
  METRICS_PORT: "9090"
  METRICS_PATH: "/metrics"
  
  # Feature Flags
  FEATURE_USER_REGISTRATION: "true"
  FEATURE_EMAIL_VERIFICATION: "true"
  FEATURE_PASSWORD_RESET: "true"
  FEATURE_SOCIAL_LOGIN: "true"
  FEATURE_TWO_FACTOR_AUTH: "false"
  FEATURE_CONTENT_CREATION: "true"
  FEATURE_CONTENT_MODERATION: "true"
  FEATURE_CONTENT_SEARCH: "true"
  FEATURE_CONTENT_RECOMMENDATIONS: "true"
  FEATURE_PROGRESS_TRACKING: "true"
  FEATURE_ACHIEVEMENTS: "true"
  FEATURE_LEADERBOARDS: "true"
  FEATURE_STREAKS: "true"
  FEATURE_COMMUNITY_FORUMS: "true"
  FEATURE_COMMUNITY_CHAT: "true"
  FEATURE_COMMUNITY_EVENTS: "true"
  FEATURE_COMMUNITY_MODERATION: "true"
  FEATURE_NOTIFICATIONS_EMAIL: "true"
  FEATURE_NOTIFICATIONS_PUSH: "true"
  FEATURE_NOTIFICATIONS_SMS: "false"
  FEATURE_NOTIFICATIONS_IN_APP: "true"
  FEATURE_ANALYTICS_DASHBOARD: "true"
  FEATURE_ANALYTICS_REPORTS: "true"
  FEATURE_ANALYTICS_AB_TESTING: "true"
  FEATURE_ANALYTICS_PREDICTIVE: "true"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  namespace: writewave-databases
  labels:
    app.kubernetes.io/name: postgres-config
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: writewave-platform
data:
  postgresql.conf: |
    # PostgreSQL Configuration for WriteWave Production
    # ================================================
    
    # Connection Settings
    listen_addresses = '*'
    port = 5432
    max_connections = 200
    superuser_reserved_connections = 3
    
    # Memory Settings
    shared_buffers = 256MB
    work_mem = 4MB
    maintenance_work_mem = 64MB
    effective_cache_size = 1GB
    
    # Write Ahead Log
    wal_level = replica
    fsync = on
    synchronous_commit = on
    wal_buffers = 16MB
    checkpoint_timeout = 5min
    max_wal_size = 1GB
    min_wal_size = 80MB
    
    # Replication
    max_wal_senders = 3
    max_replication_slots = 3
    hot_standby = on
    
    # Query Tuning
    random_page_cost = 4.0
    effective_io_concurrency = 200
    
    # Logging
    log_destination = 'stderr'
    logging_collector = on
    log_directory = 'log'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_rotation_age = 1d
    log_rotation_size = 10MB
    log_min_messages = warning
    log_min_error_statement = error
    log_min_duration_statement = 1000
    
    # Autovacuum
    autovacuum = on
    autovacuum_max_workers = 3
    autovacuum_naptime = 1min
    
    # Statistics
    track_activities = on
    track_counts = on
    track_io_timing = on
    
    # Security
    ssl = on
    ssl_cert_file = 'server.crt'
    ssl_key_file = 'server.key'
    
  pg_hba.conf: |
    # PostgreSQL Client Authentication Configuration
    # =============================================
    
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    
    # "local" is for Unix domain socket connections only
    local   all             all                                     trust
    
    # IPv4 local connections:
    host    all             all             127.0.0.1/32            scram-sha-256
    host    all             all             0.0.0.0/0               scram-sha-256
    
    # IPv6 local connections:
    host    all             all             ::1/128                 scram-sha-256
    
    # Allow replication connections
    local   replication     all                                     trust
    host    replication     all             127.0.0.1/32            scram-sha-256
    host    replication     all             ::1/128                 scram-sha-256
    
    # Allow connections from Kubernetes pods
    host    all             all             10.0.0.0/8              scram-sha-256
    host    all             all             172.16.0.0/12           scram-sha-256
    host    all             all             192.168.0.0/16          scram-sha-256
    
    # SSL connections
    hostssl all             all             0.0.0.0/0               scram-sha-256
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-config
  namespace: writewave-databases
  labels:
    app.kubernetes.io/name: redis-config
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: writewave-platform
data:
  redis.conf: |
    # Redis Configuration for WriteWave Production
    # ===========================================
    
    # Network
    bind 0.0.0.0
    port 6379
    tcp-backlog 511
    timeout 300
    tcp-keepalive 60
    
    # General
    daemonize no
    supervised no
    pidfile /var/run/redis_6379.pid
    loglevel notice
    logfile ""
    databases 16
    
    # Snapshotting
    save 900 1
    save 300 10
    save 60 10000
    stop-writes-on-bgsave-error yes
    rdbcompression yes
    rdbchecksum yes
    dbfilename dump.rdb
    dir /data
    
    # Replication
    replica-serve-stale-data yes
    replica-read-only yes
    repl-diskless-sync no
    repl-diskless-sync-delay 5
    repl-ping-replica-period 10
    repl-timeout 60
    repl-disable-tcp-nodelay no
    repl-backlog-size 1mb
    repl-backlog-ttl 3600
    replica-priority 100
    min-replicas-to-write 1
    min-replicas-max-lag 10
    
    # Security
    requirepass ${REDIS_PASSWORD}
    rename-command FLUSHDB ""
    rename-command FLUSHALL ""
    rename-command KEYS ""
    rename-command CONFIG ""
    rename-command SHUTDOWN SHUTDOWN_WRITEWAVE
    rename-command DEBUG ""
    
    # Clients
    maxclients 10000
    
    # Memory Management
    maxmemory 1gb
    maxmemory-policy allkeys-lru
    maxmemory-samples 5
    
    # Lazy Freeing
    lazyfree-lazy-eviction no
    lazyfree-lazy-expire no
    lazyfree-lazy-server-del no
    replica-lazy-flush no
    
    # Append Only File
    appendonly yes
    appendfilename "appendonly.aof"
    appendfsync everysec
    no-appendfsync-on-rewrite no
    auto-aof-rewrite-percentage 100
    auto-aof-rewrite-min-size 64mb
    aof-load-truncated yes
    aof-use-rdb-preamble yes
    
    # Lua Scripting
    lua-time-limit 5000
    
    # Slow Log
    slowlog-log-slower-than 10000
    slowlog-max-len 128
    
    # Latency Monitor
    latency-monitor-threshold 100
    
    # Event Notification
    notify-keyspace-events ""
    
    # Advanced Config
    hash-max-ziplist-entries 512
    hash-max-ziplist-value 64
    list-max-ziplist-size -2
    list-compress-depth 0
    set-max-intset-entries 512
    zset-max-ziplist-entries 128
    zset-max-ziplist-value 64
    hll-sparse-max-bytes 3000
    stream-node-max-bytes 4096
    stream-node-max-entries 100
    activerehashing yes
    client-output-buffer-limit normal 0 0 0
    client-output-buffer-limit replica 256mb 64mb 60
    client-output-buffer-limit pubsub 32mb 8mb 60
    hz 10
    dynamic-hz yes
    aof-rewrite-incremental-fsync yes
    rdb-save-incremental-fsync yes
    
    # Cluster Configuration
    cluster-enabled yes
    cluster-config-file nodes.conf
    cluster-node-timeout 5000
    cluster-require-full-coverage yes
    cluster-allow-reads-when-down no
    cluster-replica-validity-factor 10
    cluster-migration-barrier 1
    cluster-allow-replica-migration yes
    
    # Disable Protected Mode
    protected-mode no
    
    # Disable THP
    disable-thp yes
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-config
  namespace: writewave-messaging
  labels:
    app.kubernetes.io/name: rabbitmq-config
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/component: messaging
    app.kubernetes.io/part-of: writewave-platform
data:
  rabbitmq.conf: |
    # RabbitMQ Configuration for WriteWave Production
    # ===============================================
    
    # Network
    listeners.tcp.default = 5672
    num_acceptors.tcp = 10
    handshake_timeout = 10000
    heartbeat = 60
    frame_max = 131072
    channel_max = 2047
    
    # Management Plugin
    management.tcp.port = 15672
    management.tcp.ip = 0.0.0.0
    management.rates_mode = basic
    management.sample_retention_policies.global.minute = 5
    management.sample_retention_policies.global.hour = 60
    management.sample_retention_policies.global.day = 1440
    
    # Logging
    log.console = true
    log.console.level = info
    log.file = false
    log.file.level = info
    log.file.rotation.date = $D0
    log.file.rotation.size = 0
    
    # Memory and Disk
    vm_memory_high_watermark.relative = 0.6
    vm_memory_high_watermark_paging_ratio = 0.5
    disk_free_limit.relative = 2.0
    disk_free_limit.absolute = 2GB
    
    # Queue Configuration
    queue_master_locator = min-masters
    queue_index_embed_msgs_below = 4096
    queue_index_max_journal_entries = 262144
    queue_index_max_entries = 1048576
    
    # Message Store
    msg_store_file_size_limit = 16777216
    msg_store_credit_disc_bound = {4000, 0}
    msg_store_io_batch_size = 4096
    
    # Connection Limits
    connection_max = 1000
    channel_max = 2047
    heartbeat = 60
    default_vhost = /
    default_user = ${RABBITMQ_USER}
    default_pass = ${RABBITMQ_PASSWORD}
    default_permissions.configure = .*
    default_permissions.read = .*
    default_permissions.write = .*
    
    # High Availability
    ha_promote_on_shutdown = when_synced
    ha_promote_on_failure = when_synced
    ha_sync_batch_size = 1
    ha_sync_mode = automatic
    
    # Performance
    collect_statistics_interval = 5000
    delegate_count = 64
    tcp_listen_options.backlog = 128
    tcp_listen_options.nodelay = true
    tcp_listen_options.keepalive = true
    tcp_listen_options.exit_on_close = false
    
    # Security
    auth_mechanisms.1 = PLAIN
    auth_mechanisms.2 = AMQPLAIN
    auth_mechanisms.3 = EXTERNAL
    auth_backends.1 = internal
    auth_backends.2 = rabbit_auth_backend_ldap
    
    # SSL/TLS
    ssl_options.cacertfile = /etc/ssl/certs/ca-cert.pem
    ssl_options.certfile = /etc/ssl/certs/server-cert.pem
    ssl_options.keyfile = /etc/ssl/private/server-key.pem
    ssl_options.verify = verify_peer
    ssl_options.fail_if_no_peer_cert = true
    ssl_options.versions.1 = tlsv1.2
    ssl_options.versions.2 = tlsv1.3
    ssl_options.ciphers.1 = ECDHE-RSA-AES256-GCM-SHA384
    ssl_options.ciphers.2 = ECDHE-RSA-AES128-GCM-SHA256
    ssl_options.ciphers.3 = ECDHE-RSA-AES256-SHA384
    ssl_options.ciphers.4 = ECDHE-RSA-AES128-SHA256
    
    # Prometheus
    prometheus.tcp.port = 15692
    prometheus.path = /metrics
    prometheus.enabled = true
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-config
  namespace: writewave-messaging
  labels:
    app.kubernetes.io/name: kafka-config
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/component: messaging
    app.kubernetes.io/part-of: writewave-platform
data:
  server.properties: |
    # Kafka Configuration for WriteWave Production
    # ===========================================
    
    # Broker Configuration
    broker.id=1
    listeners=PLAINTEXT://0.0.0.0:9092
    advertised.listeners=PLAINTEXT://kafka-1:9092
    listener.security.protocol.map=PLAINTEXT:PLAINTEXT
    inter.broker.listener.name=PLAINTEXT
    
    # Zookeeper Configuration
    zookeeper.connect=zookeeper:2181
    zookeeper.connection.timeout.ms=18000
    
    # Log Configuration
    log.dirs=/var/lib/kafka/data
    log.retention.hours=168
    log.retention.bytes=1073741824
    log.segment.bytes=1073741824
    log.cleanup.policy=delete
    log.flush.interval.messages=10000
    log.flush.interval.ms=1000
    
    # Replication Configuration
    num.replica.fetchers=4
    replica.fetch.max.bytes=1048576
    replica.fetch.wait.max.ms=500
    replica.high.watermark.checkpoint.interval.ms=5000
    replica.lag.time.max.ms=10000
    replica.socket.timeout.ms=30000
    replica.socket.receive.buffer.bytes=65536
    
    # Partition Configuration
    num.partitions=3
    default.replication.factor=3
    min.insync.replicas=2
    unclean.leader.election.enable=false
    
    # Compression Configuration
    compression.type=snappy
    message.max.bytes=1048576
    replica.fetch.max.bytes=1048576
    
    # Performance Configuration
    batch.size=16384
    linger.ms=5
    buffer.memory=33554432
    max.request.size=1048576
    send.buffer.bytes=131072
    receive.buffer.bytes=32768
    
    # Security Configuration
    security.inter.broker.protocol=PLAINTEXT
    ssl.keystore.location=/var/ssl/private/kafka.server.keystore.jks
    ssl.keystore.password=test1234
    ssl.key.password=test1234
    ssl.truststore.location=/var/ssl/private/kafka.server.truststore.jks
    ssl.truststore.password=test1234
    ssl.client.auth=required
    ssl.enabled.protocols=TLSv1.2,TLSv1.3
    ssl.keystore.type=JKS
    ssl.truststore.type=JKS
    
    # Monitoring Configuration
    metrics.enabled=true
    metrics.reporters=io.confluent.metrics.reporter.ConfluentMetricsReporter
    confluent.metrics.reporter.bootstrap.servers=localhost:9092
    confluent.metrics.reporter.topic.replicas=3
    confluent.metrics.enable=true
    confluent.support.metrics.enable=true
    confluent.support.customer.id=anonymous
    
    # JMX Configuration
    jmx.port=9999
    
    # Auto Topic Creation
    auto.create.topics.enable=true
    delete.topic.enable=true
    
    # Group Configuration
    group.initial.rebalance.delay.ms=0
    group.max.session.timeout.ms=300000
    group.min.session.timeout.ms=6000
    
    # Offset Configuration
    offsets.topic.replication.factor=3
    offsets.topic.num.partitions=50
    offsets.retention.minutes=10080
    offsets.load.buffer.size=5242880
    offsets.commit.required.acks=-1
    offsets.commit.timeout.ms=5000
    
    # Transaction Configuration
    transaction.state.log.replication.factor=3
    transaction.state.log.min.isr=2
    transaction.state.log.num.partitions=50
    transaction.abort.timed.out.transaction.cleanup.interval.ms=10000
    transaction.max.timeout.ms=900000
    transaction.remove.expired.transaction.cleanup.interval.ms=3600000
    
    # Controller Configuration
    controller.quorum.election.timeout.ms=5000
    controller.quorum.fetch.timeout.ms=2000
    controller.quorum.retry.backoff.ms=20
    controller.quorum.request.timeout.ms=2000
    controller.quorum.voters=1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093
