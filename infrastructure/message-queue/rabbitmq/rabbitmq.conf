# RabbitMQ Configuration for WriteWave Microservices
# ==================================================

# Network
listeners.tcp.default = 5672
num_acceptors.tcp = 10
handshake_timeout = 10000
heartbeat = 60
frame_max = 131072
channel_max = 2047

# Management Plugin
management.tcp.port = 15672
management.tcp.ip = 0.0.0.0
management.rates_mode = basic
management.sample_retention_policies.global.minute = 5
management.sample_retention_policies.global.hour = 60
management.sample_retention_policies.global.day = 1440

# Logging
log.console = true
log.console.level = info
log.file = false
log.file.level = info
log.file.rotation.date = $D0
log.file.rotation.size = 0

# Memory and Disk
vm_memory_high_watermark.relative = 0.6
vm_memory_high_watermark_paging_ratio = 0.5
disk_free_limit.relative = 2.0
disk_free_limit.absolute = 2GB

# Queue Configuration
queue_master_locator = min-masters
queue_index_embed_msgs_below = 4096
queue_index_max_journal_entries = 262144
queue_index_max_entries = 1048576

# Message Store
msg_store_file_size_limit = 16777216
msg_store_credit_disc_bound = {4000, 0}
msg_store_io_batch_size = 4096

# Connection Limits
connection_max = 1000
channel_max = 2047
heartbeat = 60
default_vhost = /
default_user = ${RABBITMQ_USER}
default_pass = ${RABBITMQ_PASSWORD}
default_permissions.configure = .*
default_permissions.read = .*
default_permissions.write = .*

# Cluster Configuration
cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config
cluster_formation.classic_config.nodes.1 = rabbit@rabbitmq-management
cluster_formation.classic_config.nodes.2 = rabbit@rabbitmq-node-2
cluster_formation.classic_config.nodes.3 = rabbit@rabbitmq-node-3
cluster_formation.node_cleanup.only_log_warning = true
cluster_formation.randomized_startup_delay_range.min = 0
cluster_formation.randomized_startup_delay_range.max = 2

# High Availability
ha_promote_on_shutdown = when_synced
ha_promote_on_failure = when_synced
ha_sync_batch_size = 1
ha_sync_mode = automatic

# Federation
federation.upstreams = {}
federation.downstreams = {}

# Shovel
shovel.configs = {}

# Policies
policies = {}

# Limits
limits.max_connections = 1000
limits.max_channels = 2047
limits.max_queues = 10000
limits.max_exchanges = 10000

# Performance
collect_statistics_interval = 5000
delegate_count = 64
tcp_listen_options.backlog = 128
tcp_listen_options.nodelay = true
tcp_listen_options.keepalive = true
tcp_listen_options.exit_on_close = false

# Security
auth_mechanisms.1 = PLAIN
auth_mechanisms.2 = AMQPLAIN
auth_mechanisms.3 = EXTERNAL
auth_backends.1 = internal
auth_backends.2 = rabbit_auth_backend_ldap

# SSL/TLS
ssl_options.cacertfile = /etc/ssl/certs/ca-cert.pem
ssl_options.certfile = /etc/ssl/certs/server-cert.pem
ssl_options.keyfile = /etc/ssl/private/server-key.pem
ssl_options.verify = verify_peer
ssl_options.fail_if_no_peer_cert = true
ssl_options.versions.1 = tlsv1.2
ssl_options.versions.2 = tlsv1.3
ssl_options.ciphers.1 = ECDHE-RSA-AES256-GCM-SHA384
ssl_options.ciphers.2 = ECDHE-RSA-AES128-GCM-SHA256
ssl_options.ciphers.3 = ECDHE-RSA-AES256-SHA384
ssl_options.ciphers.4 = ECDHE-RSA-AES128-SHA256

# MQTT
mqtt.listeners.tcp.default = 1883
mqtt.listeners.ssl.default = 8883
mqtt.allow_anonymous = false
mqtt.vhost = /
mqtt.exchange = amq.topic
mqtt.subscription_ttl = 1800000
mqtt.prefetch = 10
mqtt.default_user = ${RABBITMQ_USER}
mqtt.default_pass = ${RABBITMQ_PASSWORD}

# STOMP
stomp.listeners.tcp.default = 61613
stomp.listeners.ssl.default = 61614
stomp.allow_anonymous = false
stomp.vhost = /
stomp.default_user = ${RABBITMQ_USER}
stomp.default_pass = ${RABBITMQ_PASSWORD}

# Web STOMP
web_stomp.listeners.tcp.default = 15674
web_stomp.listeners.ssl.default = 15675
web_stomp.allow_anonymous = false
web_stomp.vhost = /
web_stomp.default_user = ${RABBITMQ_USER}
web_stomp.default_pass = ${RABBITMQ_PASSWORD}

# Web MQTT
web_mqtt.listeners.tcp.default = 15675
web_mqtt.listeners.ssl.default = 15676
web_mqtt.allow_anonymous = false
web_mqtt.vhost = /
web_mqtt.default_user = ${RABBITMQ_USER}
web_mqtt.default_pass = ${RABBITMQ_PASSWORD}

# Prometheus
prometheus.tcp.port = 15692
prometheus.path = /metrics
prometheus.enabled = true

# Feature Flags
feature_flags.1 = quorum_queue
feature_flags.2 = stream_queue
feature_flags.3 = stream_single_active_consumer
feature_flags.4 = stream_leader_locator_balanced
feature_flags.5 = stream_leader_locator_client_local
feature_flags.6 = stream_leader_locator_least_leaders
feature_flags.7 = stream_leader_locator_min_leader
feature_flags.8 = stream_leader_locator_min_traffic
feature_flags.9 = stream_leader_locator_random
feature_flags.10 = stream_leader_locator_random_balanced
feature_flags.11 = stream_leader_locator_random_balanced_rack_aware
feature_flags.12 = stream_leader_locator_random_rack_aware
feature_flags.13 = stream_leader_locator_rack_aware
feature_flags.14 = stream_leader_locator_rack_aware_balanced
feature_flags.15 = stream_leader_locator_rack_aware_balanced_random
feature_flags.16 = stream_leader_locator_rack_aware_balanced_random_rack_aware
feature_flags.17 = stream_leader_locator_rack_aware_balanced_random_rack_aware_balanced
feature_flags.18 = stream_leader_locator_rack_aware_balanced_random_rack_aware_balanced_random
feature_flags.19 = stream_leader_locator_rack_aware_balanced_random_rack_aware_balanced_random_rack_aware
feature_flags.20 = stream_leader_locator_rack_aware_balanced_random_rack_aware_balanced_random_rack_aware_balanced
