name: Comprehensive Testing Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1' # Weekly on Monday at 2 AM

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # Unit and Integration Tests
  unit-tests:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Install dependencies
        run: |
          cd frontend
          pnpm install --frozen-lockfile
          
      - name: Run linting
        run: |
          cd frontend
          pnpm run lint
          
      - name: Run type checking
        run: |
          cd frontend
          pnpm run type-check
          
      - name: Run unit tests
        run: |
          cd frontend
          pnpm run test:unit
        env:
          CI: true
          
      - name: Run integration tests
        run: |
          cd frontend
          pnpm run test:integration
        env:
          CI: true
          
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./frontend/coverage/lcov.info
          flags: unit-tests
          name: unit-tests-coverage
          
      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: unit-test-results
          path: |
            frontend/coverage/
            frontend/test-results/
          retention-days: 30

  # End-to-End Tests
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: unit-tests
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Install dependencies
        run: |
          cd frontend
          pnpm install --frozen-lockfile
          
      - name: Build application
        run: |
          cd frontend
          pnpm run build
          
      - name: Install Playwright browsers
        run: |
          cd frontend
          pnpm exec playwright install --with-deps ${{ matrix.browser }}
          
      - name: Run E2E tests
        run: |
          cd frontend
          pnpm run test:e2e --project=${{ matrix.browser }}
        env:
          CI: true
          
      - name: Upload E2E test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-test-results-${{ matrix.browser }}
          path: |
            frontend/test-results/
            frontend/playwright-report/
          retention-days: 30
          
      - name: Upload E2E screenshots
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: e2e-screenshots-${{ matrix.browser }}
          path: frontend/test-results/
          retention-days: 7

  # Performance Tests
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: unit-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Install dependencies
        run: |
          cd frontend
          pnpm install --frozen-lockfile
          
      - name: Build application
        run: |
          cd frontend
          pnpm run build
          
      - name: Install Playwright browsers
        run: |
          cd frontend
          pnpm exec playwright install --with-deps chromium
          
      - name: Run performance tests
        run: |
          cd frontend
          pnpm run test:performance
        env:
          CI: true
          
      - name: Upload performance results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: performance-test-results
          path: frontend/performance-results/
          retention-days: 30
          
      - name: Comment performance results
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              const resultsPath = path.join('frontend', 'performance-results', 'results.json');
              if (fs.existsSync(resultsPath)) {
                const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
                
                const comment = `## Performance Test Results
                
                | Metric | Value | Threshold | Status |
                |--------|-------|-----------|--------|
                | Dashboard Load Time | ${results.dashboardLoadTime}ms | < 2000ms | ${results.dashboardLoadTime < 2000 ? 'âœ…' : 'âŒ'} |
                | OCR Response Time | ${results.ocrResponseTime}ms | < 500ms | ${results.ocrResponseTime < 500 ? 'âœ…' : 'âŒ'} |
                | Canvas Drawing Time | ${results.canvasDrawingTime}ms | < 1000ms | ${results.canvasDrawingTime < 1000 ? 'âœ…' : 'âŒ'} |
                | Memory Usage | ${results.memoryUsage}MB | < 50MB | ${results.memoryUsage < 50 ? 'âœ…' : 'âŒ'} |
                
                ${results.violations.length > 0 ? `### Performance Violations\n${results.violations.map(v => `- ${v}`).join('\n')}` : ''}
                `;
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            } catch (error) {
              console.log('Could not read performance results:', error);
            }

  # Accessibility Tests
  accessibility-tests:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: unit-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Install dependencies
        run: |
          cd frontend
          pnpm install --frozen-lockfile
          
      - name: Build application
        run: |
          cd frontend
          pnpm run build
          
      - name: Install Playwright browsers
        run: |
          cd frontend
          pnpm exec playwright install --with-deps chromium
          
      - name: Run accessibility tests
        run: |
          cd frontend
          pnpm run test:accessibility
        env:
          CI: true
          
      - name: Upload accessibility results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: accessibility-test-results
          path: frontend/accessibility-results/
          retention-days: 30
          
      - name: Comment accessibility results
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              const resultsPath = path.join('frontend', 'accessibility-results', 'violations.json');
              if (fs.existsSync(resultsPath)) {
                const violations = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
                
                if (violations.length === 0) {
                  const comment = `## Accessibility Test Results âœ…
                  
                  No accessibility violations found! The application meets WCAG 2.1 AA standards.`;
                  
                  github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: comment
                  });
                } else {
                  const comment = `## Accessibility Test Results âŒ
                  
                  Found ${violations.length} accessibility violations:
                  
                  ${violations.map(v => `- **${v.rule}**: ${v.description}`).join('\n')}
                  
                  Please fix these issues to ensure the application is accessible to all users.`;
                  
                  github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: comment
                  });
                }
              }
            } catch (error) {
              console.log('Could not read accessibility results:', error);
            }

  # Security Tests
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: unit-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Install dependencies
        run: |
          cd frontend
          pnpm install --frozen-lockfile
          
      - name: Run security audit
        run: |
          cd frontend
          pnpm audit --audit-level moderate
          
      - name: Run dependency check
        run: |
          cd frontend
          pnpm run security:check
          
      - name: Upload security results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-test-results
          path: frontend/security-results/
          retention-days: 30

  # Cross-browser Compatibility Tests
  cross-browser-tests:
    name: Cross-Browser Compatibility
    runs-on: ubuntu-latest
    timeout-minutes: 40
    needs: unit-tests
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        viewport: [desktop, mobile]
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Install dependencies
        run: |
          cd frontend
          pnpm install --frozen-lockfile
          
      - name: Build application
        run: |
          cd frontend
          pnpm run build
          
      - name: Install Playwright browsers
        run: |
          cd frontend
          pnpm exec playwright install --with-deps ${{ matrix.browser }}
          
      - name: Run cross-browser tests
        run: |
          cd frontend
          pnpm run test:cross-browser --project=${{ matrix.browser }} --viewport=${{ matrix.viewport }}
        env:
          CI: true
          
      - name: Upload cross-browser results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: cross-browser-results-${{ matrix.browser }}-${{ matrix.viewport }}
          path: frontend/test-results/
          retention-days: 30

  # Test Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-tests, performance-tests, accessibility-tests, security-tests, cross-browser-tests]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts/
          
      - name: Generate test summary
        run: |
          echo "# Test Summary" > test-summary.md
          echo "" >> test-summary.md
          echo "## Test Results" >> test-summary.md
          echo "" >> test-summary.md
          echo "| Test Suite | Status |" >> test-summary.md
          echo "|------------|--------|" >> test-summary.md
          echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> test-summary.md
          echo "| E2E Tests | ${{ needs.e2e-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> test-summary.md
          echo "| Performance Tests | ${{ needs.performance-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> test-summary.md
          echo "| Accessibility Tests | ${{ needs.accessibility-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> test-summary.md
          echo "| Security Tests | ${{ needs.security-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> test-summary.md
          echo "| Cross-Browser Tests | ${{ needs.cross-browser-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> test-summary.md
          echo "" >> test-summary.md
          echo "## Overall Status" >> test-summary.md
          echo "" >> test-summary.md
          if [ "${{ needs.unit-tests.result }}" == "success" ] && [ "${{ needs.e2e-tests.result }}" == "success" ] && [ "${{ needs.performance-tests.result }}" == "success" ] && [ "${{ needs.accessibility-tests.result }}" == "success" ] && [ "${{ needs.security-tests.result }}" == "success" ] && [ "${{ needs.cross-browser-tests.result }}" == "success" ]; then
            echo "ðŸŽ‰ All tests passed! The application is ready for deployment." >> test-summary.md
          else
            echo "âš ï¸ Some tests failed. Please review the results and fix any issues." >> test-summary.md
          fi
          
      - name: Upload test summary
        uses: actions/upload-artifact@v3
        with:
          name: test-summary
          path: test-summary.md
          retention-days: 30
          
      - name: Comment test summary
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('test-summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
